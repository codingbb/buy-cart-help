{{> layout/header}}

<style>
    .offer-table th, .offer-table td {
        text-align: center;
        vertical-align: middle; /* 셀 내용을 수직 가운데 정렬 */
    }

    .notVisible {
        visibility: hidden;
    }

</style>

<div class="container">

    <form action="/order-cancel" method="post">

        <table class="table table-hover offer-table scroll" style="text-align: center; border-top:2px solid #ddd">
            <br>
            <h2>내 구매 목록</h2>
            <br>
            <!--        목록 -->
            <thead>
            <tr>
                <th class="center-align col-1">No</th>
                <th class="center-align col-2">상품명</th>
                <th class="center-align col-1">수량</th>
                <th class="center-align col-2">상품가격</th>
                <th class="center-align col-2">결제방법</th>
                <th class="center-align col-2">주문날짜</th>
                <th class="center-align col-2">현재상태</th>
            </tr>
            </thead>
            <!--        목록 끝-->

            <!--        상품 테이블-->
            <tbody>
            {{#orderList}}
                <tr class="offer-table my-cancel-list">
                    <th scope="row">{{indexNum}}</th>
                    <td>{{name}}</td>
                    <td class="buyQty">{{buyQty}}</td>
                    <td class="sum">{{sum}}</td>
                    <td>{{payment}}</td>
                    <td>{{createdAt}}</td>
                    <td>
                        <div class="notVisible">{{id}}</div>
                        <div class="notVisible">{{status}}</div>
                        <input type="checkbox" name="itemCheck" id="itemCheck" class="item-checkbox">
                    </td>
                </tr>
            {{/orderList}}
            </tbody>
            <!--        상품 테이블 끝-->
        </table>

        <div class="new-create-button d-flex justify-content-end cancelButton">
            <button type="submit" id="cancelButton" class="btn btn-outline-danger">주문취소</button>
        </div>

    </form>
</div>

<div style="margin-bottom: 15%"></div>

<script src="/js/list.js"></script>


<script>

    // 카트가 리스트로 들어오기 때문에 빈 배열 선언

    // #purchaseButton 버튼에 click 이벤트 리스너 추가. *keyup인지 확인 필요
    document.querySelector("#cancelButton").addEventListener("click", function (e) {
        e.preventDefault();

        let cancelList = document.querySelectorAll(".my-cancel-list");

        let cancelTable = [];

        cancelList.forEach(value => {

            let checkBox = value.querySelector(".item-checkbox");

            // 체크박스에 체크가 된 상태일 때
            // 즉, true 일 때. checked면 true를 뜻하기 때문에 생략 가능!
            if(checkBox.checked){

                // 체크박스를 통해 선택한 상품의 cartId와 구매 수량(buyQty)을 추출
                let info = value.querySelectorAll("td > div");   //조건에 맞는 모든 요소를 배열 형식으로 반환. 여기서 info 변수는 선택된 <div> 태그들의 배열을 가지게 됨.
                let orderId = info[0].innerText;   //info 배열의 첫 번째 요소(즉, 첫 번째 <div> 태그)의 HTML 내용을 가져온다.
                let buyQty = value.querySelector(".buyQty").value;  //사용자가 입력한 값을 가져옴
                let status = value.querySelector("td > div").value;
                //console.log(cartId);
                //console.log(buyQty);

                //이런 식으로 데이터가 들어올 거고, requestDTO랑 필드명 맞춰주면 받아올 것임!!
                let cancelCheck = {
                    orderId: orderId,
                    buyQty: buyQty,
                    status: status
                };

                // cartList 배열에 checkedCart 값 추가!!
                cancelTable.push(cancelCheck);
            }
        });

        console.log(cancelTable);

        // 통신이잖아요? json으로 받을 것
        $.ajax({
            url: '/order-cancel',
            data: JSON.stringify(cancelTable),
            contentType: 'application/json; charset=utf-8',
            type: 'POST'

            // 성공하면 이쪽으로!
        }).done((res)=>{
            alert(`res : ${res}`);
            location.href = "/order-list"

        }).fail((res)=>{

        });
    });


</script>


{{> layout/footer}}
